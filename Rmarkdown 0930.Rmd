---
title: "Preliminary data cleaning and analysis for exploring Schedule instability"
author: "Zhuofei"
date: "`r Sys.Date()`"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Sequence analysis practise
This is Zhuofei Lu's practise of sequence analysis. The original code drawn from
Kamila Kolpashnikova:<https://github.com/Kolpashnikova/Sequence_Analysis_Workshop.git>.

## Install packages

```{r}
if (!require("pacman")) install.packages("pacman")
```

## Loading required package: pacman

```{r}
library(pacman)
```

## load and install packages

```{r}
pacman::p_load(TraMineR, TraMineRextras, cluster, RColorBrewer, devtools, haven, 
               tidyverse, reshape2, WeightedCluster, nnet)
```

## Load .dta (Stata) Dataset

```{r}
setwd("E:/OneDrive/SciencesPo/data")
## LL: you should create a R project using this directory instead of setting manually your working directory
## it makes your code stronger and independent of personal configurations
X3 <- read_dta("3days_cleaned0928.dta")
## I would also suggest not to use capital letters for R objects as it makes the code a little bit more difficult to write
## and if you use only lower cases as a rule, it makes R code safer from case errors
```

## Color Palette

```{r}
colourCount = 13
getPalette = colorRampPalette(brewer.pal(9, "Set3"))
```





############################### [Updated on 11/10/2023] intra-individual measure of schedule instability (using 2 diary days) 

dat <- tibble(id = c(1,1,2,2),
              x1 = c(0,1,1,1),
              x2 = c(0,1,1,1),
              x3 = c(0,1, 0, 1))
# with dplyr

dat %>%
  group_by(id) %>%
  summarise(d = dist(data.frame(x1, x2, x3), method = "manhattan‚Äù))

# with data.table

setDT(dat)
dat[ , .(d = dist(.SD, method = "manhattan")), by = id, .SD = x1:x3]


############################### [Updated on 12/10/2023] intra-individual measure of schedule instability (using 3 diary days)

dat <- tibble(id = c(1,1,1,2,2,2),
              x1 = c(0,1,0,0,1,1),
              x2 = c(1,1,0,1,1,1),
              x3 = c(0,1,0,1,0,1))

compute_distances <- function(data){
  observations <- as.matrix(data.frame(data$x1, data$x2, data$x3))
  distances <- dist(observations, method = "manhattan")
  return(as.vector(distances))
}

distances_by_id <- dat %>%
  group_by(id) %>%
  group_map(~ tibble(distance = compute_distances(.x)), .keep = TRUE)

distances_df <- bind_rows(distances_by_id, .id = "id")

print(distances_df)

## variance
distances_df %>%
  group_by(id) %>%
  summarise(variance = var(distance, na.rm = TRUE))

## mean
mean_distances <- distances_df %>%
  group_by(id) %>%
  summarise(mean_distance = mean(distance))

print(mean_distances)

