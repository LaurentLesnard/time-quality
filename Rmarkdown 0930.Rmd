---
title: "Preliminary data cleaning and analysis for exploring Schedule instability"
author: "Zhuofei"
date: "`r Sys.Date()`"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Sequence analysis practise
This is Zhuofei Lu's practise of sequence analysis. The original code drawn from
Kamila Kolpashnikova:<https://github.com/Kolpashnikova/Sequence_Analysis_Workshop.git>.

## Install packages

```{r}
if (!require("pacman")) install.packages("pacman")
```

## Loading required package: pacman

```{r}
library(pacman)
```

## load and install packages

```{r}
pacman::p_load(TraMineR, TraMineRextras, cluster, RColorBrewer, devtools, haven, 
               tidyverse, reshape2, WeightedCluster, nnet)
```

## Load .dta (Stata) Dataset

```{r}
setwd("E:/OneDrive/SciencesPo/data")
## LL: you should create a R project using this directory instead of setting manually your working directory
## it makes your code stronger and independent of personal configurations
X3 <- read_dta("3days_cleaned0928.dta")
## I would also suggest not to use capital letters for R objects as it makes the code a little bit more difficult to write
## and if you use only lower cases as a rule, it makes R code safer from case errors
```

## Color Palette

```{r}
colourCount = 13
getPalette = colorRampPalette(brewer.pal(9, "Set3"))
```





############################### [Updated on 11/10/2023] intra-individual measure of schedule instability (using 2 diary days) 

dat <- tibble(id = c(1,1,2,2),
              x1 = c(0,1,1,1),
              x2 = c(0,1,1,1),
              x3 = c(0,1, 0, 1))
# with dplyr

dat %>%
  group_by(id) %>%
  summarise(d = dist(data.frame(x1, x2, x3), method = "manhattan‚Äù))

# with data.table

setDT(dat)
dat[ , .(d = dist(.SD, method = "manhattan")), by = id, .SD = x1:x3]


############################### [Updated on 17/10/2023] intra-individual measure of schedule instability (using 3 diary days)
## Example for practise
library(data.table)
library(tibble)

dat <- tibble(id = c(1,1,1,2,2,2),
              x1 = c(0,1,0,0,1,1),
              x2 = c(1,1,0,1,1,1),
              x3 = c(0,1,0,1,0,1))
setDT(dat)

# use data.table to estimate manhattan distance
distances_df <- dat[, .(distance = dist(.SD, method = "manhattan")), by = id, .SDcols = x1:x3]

# print manhattan distance
print(distances_df)

# use data.table  to estimate mean and variance
summary_stats <- distances_df[, .(mean_distance = mean(distance), variance = var(distance)), by = id]

# print mean and variance
print(summary_stats)


##Use UKTUS for practise
X3 <- X3 %>%
  group_by(mainid) %>%
  mutate(ndays = n())
d2 <- X3  %>%
  filter(ndays == 2)
head(d2$mainid)

setDT(X3)

distances_df <- X3[, .(distance = dist(.SD, method = "manhattan")), by = mainid, .SDcols = w_pri1:w_pri144]
print(distances_df)

mean_distances <- distances_df[, .(mean_distance = mean(distance)), by = mainid]

X3 <- X3 %>% 
  left_join(mean_distances, by = "mainid")

summary(X3$mean_distance)

table(X3$wfh)

model1 <- lm(mean_distance ~ wfh , data=X3)
summary(model1)

install.packages("plm")
library(plm)
model2 <- plm(frag_start ~ workplace , data=X3, index=c("mainid", "diaryord"), model="random")
summary(model2)

